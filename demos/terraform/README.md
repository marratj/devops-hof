# Terraform

## Create Storage Bucket for remote state

```bash
PROJECT=<your-project>
LOCATION=<your-location>
BUCKET_NAME=<your-bucket-name>

gsutil mb -p $PROJECT -l $LOCATION gs://$BUCKET_NAME/
```

## Set Kubeconfig path for generated Cluster
```
export KUBECONFIG=kubeconfig
```

## Configure Terraform Backend

[state.tf](state.tf)

## Initialize Terraform

```bash
terraform init
```

## Create environment

```bash
terraform plan -out tfplan

# After review of plan
terraform apply tfplan
```

## Obtain Cluster Credentials

Only in case the kubeconfig was not correctly generated by Terrform:

```bash
gcloud container clusters get-credentials <cluster_name> --project $PROJECT --zone <cluster_zone>
```

## Giving write access to Flux

At startup Flux generates a SSH key and logs the public key. Find
the SSH public key with:

```sh
kubectl logs deployment/flux | grep identity.pub | cut -d '"' -f2
```

*Note:* If you have downloaded [fluxctl](./fluxctl.md) already, you can use
`fluxctl identity` as well.

In order to sync your cluster state with git you need to copy the
public key and create a deploy key with write access on your GitHub
repository.

Open GitHub, navigate to your fork, go to **Setting > Deploy keys**,
click on **Add deploy key**, give it a name, check **Allow write
access**, paste the Flux public key and click **Add key**.

(Or replace `YOURUSER` with your Github ID in this url:
`https://github.com/YOURUSER/flux-get-started/settings/keys/new` and
paste the key there.)


## Get Ingress Load Balancer IP

A few minutes after deployment, a GKE load balancer will be ready for ingress-nginx. Obtain its public IP:

```bash
kubectl -n ingress-nginx get svc ingress-nginx -o jsonpath='{ .status.loadBalancer.ingress..ip }'
```